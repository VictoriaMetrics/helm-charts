{{- $top := . -}}
{{- range $zone := .Values.availabilityZones }}
{{- if $zone.vmauthQueryPerZone.enabled }}
---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAuth
metadata:
  name: {{ $zone.vmauthQueryPerZone.name }}-{{ $zone.name }}
  namespace: {{ $top.Release.Namespace }}
  labels: {{ include "victoria-metrics-distributed.labels" $top | nindent 4 }}
  {{- with $zone.vmauthQueryPerZone.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end  }}
spec:
{{- $nodeSelector := deepCopy $zone.nodeSelector }}
{{- if $zone.vmauthQueryPerZone.spec.nodeSelector }}
{{- $nodeSelector = mergeOverwrite (deepCopy $zone.nodeSelector) $zone.vmauthQueryPerZone.spec.nodeSelector }}
{{- end }}
  nodeSelector:
{{- toYaml $nodeSelector | nindent 4 }}
{{- $topologySpreadConstraints := deepCopy $zone.topologySpreadConstraints }}
{{- if $zone.vmauthQueryPerZone.spec.topologySpreadConstraints }}
{{- $topologySpreadConstraints = mergeOverwrite (deepCopy $zone.topologySpreadConstraints) $zone.vmauthQueryPerZone.spec.topologySpreadConstraints }}
{{- end }}
  topologySpreadConstraints:
{{- toYaml $topologySpreadConstraints | nindent 4 }}
  unauthorizedAccessConfig:
    - src_paths:
        - "/select/.+"
      url_prefix:
{{- range $i := until (int $zone.vmcluster.spec.vmselect.replicaCount) }}
{{ printf "- http://vmselect-vmcluster-%s-%d.vmselect-vmcluster-%s:8481/" $zone.name $i $zone.name | indent 8 }}
{{- end }}
{{- end }}
{{- end }}

