{{- /* This template generates readonly and admin cluster roles for */ -}}
{{- /* each CRD present in the helm chart.  The clusterroles use the */ -}}
{{- /* kubernetes clusterrole aggregation feature to include these */ -}}
{{- /* cluster roles into the default view and admin roles */ -}}
{{- /* See https://kubernetes.io/docs/reference/access-authn-authz/rbac/#aggregated-clusterroles */ -}}
{{- if or .Values.createCRD .Values.crd.create .Values.rbac.aggregatedClusterRoles.enabled }}
{{- $files := .Files }}
{{- $fileContentsList := $files.Get "crd.yaml" | splitList "---" }}
{{- $groups := dict }}
{{- range $fileContentsList }}
  {{- $fileContents := . | fromYaml }}
  {{- $group := $fileContents.spec.group }}
  {{- $plural:= $fileContents.spec.names.plural }}
  {{- $resources := get $groups $group | default (list) }}
  {{- $resources = append $resources $plural }}
  {{- $groups = set $groups $group $resources }}
{{- end }}

{{- $clusterRules := default list }}
{{- $rules := default list }}
{{- $clusterVerbs := list "*" }}
{{- $verbs := list "get" "list" "watch" }}
{{- range $group, $resources := $groups }}
  {{- $rules = append $rules (dict "apiGroups" (list $group) "resources" $resources "verbs" $verbs) }}
  {{- $clusterRules = append $clusterRules (dict "apiGroups" (list $group) "resources" $resources "verbs" $clusterVerbs) }}
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: victoriametrics:admin
  labels:
    {{- include "vm-operator.labels" . | nindent 4 }}
    {{- .Values.rbac.aggregatedClusterRoles.labels.admin | toYaml | nindent 4 }}
rules: {{ toYaml $clusterRules | nindent 2 }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: victoriametrics:view
  labels:
    {{- include "vm-operator.labels" . | nindent 4 }}
    {{- .Values.rbac.aggregatedClusterRoles.labels.view | toYaml | nindent 4 }}
rules: {{ toYaml $rules | nindent 2 }}
{{- end }}
