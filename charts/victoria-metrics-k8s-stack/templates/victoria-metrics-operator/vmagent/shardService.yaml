{{- if .Values.vmagent.spec.shardCount }}
  {{- $shardCountStr := .Values.vmagent.spec.shardCount }}
  {{- $shardCount := int $shardCountStr | default 0 }}
  {{- $servicePort := 8429 -}}
  {{- $serviceName := printf "%s-%s" "vmagent" (include "victoria-metrics-k8s-stack.fullname" .) | trunc 63 | trimSuffix "-" }}
  {{- if and (gt $shardCount 0) (not (eq (typeOf $shardCountStr) "string")) }}
    {{- range $i := until $shardCount }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $serviceName }}-shard-{{ $i }}
  labels:
    {{- include "victoria-metrics-k8s-stack.labels" . | nindent 4 }}
    shard: "{{ $i }}"
spec:
  selector:
    {{- include "victoria-metrics-k8s-stack.selectorLabels" . | nindent 4 }}
    shard-num: "{{ $i }}"
  ports:
    - protocol: TCP
      port: {{ $servicePort }}
      targetPort: {{ $servicePort }}
    {{- end }}
  {{- end }}
{{- end }}
